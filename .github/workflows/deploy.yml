name: Deploy EinUI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production

    env:
      VPS_PORT: ${{ secrets.VPS_PORT != '' && secrets.VPS_PORT || '22' }}
      GITHUB_REPO: ${{ github.repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          if [ -z "$VPS_SSH_KEY" ]; then
            echo "‚ùå VPS_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "$VPS_HOST" ]; then
            echo "‚ùå VPS_HOST secret is not set"
            exit 1
          fi
          if [ -z "$VPS_USER" ]; then
            echo "‚ùå VPS_USER secret is not set"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ env.VPS_PORT }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -p ${{ env.VPS_PORT }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 $VPS_USER@$VPS_HOST << DEPLOY_SCRIPT
            set -e

            echo "üöÄ Starting deployment..."

            DEPLOY_PATH="\$HOME/persian-blog"

            # Navigate to deployment directory
            if [ ! -d "\$DEPLOY_PATH" ]; then
              echo "üìÅ Creating deployment directory: \$DEPLOY_PATH"
              mkdir -p "\$DEPLOY_PATH"
            fi

            cd "\$DEPLOY_PATH" || { echo "‚ùå Failed to enter deploy path"; exit 1; }

            # Clone or update repository if not already present
            if [ ! -d ".git" ]; then
              echo "üì¶ Cloning repository..."
              git clone git@github.com:${{ env.GITHUB_REPO }}.git .
            else
              echo "üîÑ Updating repository..."
              git fetch origin main
              git reset --hard origin/main
            fi

            # Stop and remove old container
            echo "üõë Stopping old container..."
            docker compose -p persian-blog --profile prod down 2>/dev/null || true

            # Build new container
            echo "üîß Building new container..."
            if ! docker compose -p persian-blog --profile prod build production 2>&1; then
              echo "‚ùå Failed to build container"
              exit 1
            fi

            # Start new container
            echo "‚ñ≤ Starting new container..."
            if ! docker compose -p persian-blog --profile prod up -d production 2>&1; then
              echo "‚ùå Failed to start container"
              exit 1
            fi

            # Wait for health check
            echo "‚è≥ Waiting for container to be ready..."
            sleep 15

            # Verify deployment
            if docker compose -p persian-blog ps | grep -q "healthy\|running"; then
              echo "‚úÖ Container is running!"
            else
              echo "‚ö†Ô∏è  Container status check"
              docker compose -p persian-blog ps
            fi

            echo "‚úÖ Deployment completed successfully!"
          DEPLOY_SCRIPT

      - name: Verify deployment
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          ssh -p ${{ env.VPS_PORT }} -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'VERIFY_SCRIPT'
            echo "üìä Checking running containers..."
            docker compose -p persian-blog --profile prod ps || echo "‚ö†Ô∏è  No containers found"

            echo ""
            echo "üìã Recent logs (last 30 lines):"
            docker compose -p persian-blog --profile prod logs --tail=30 production 2>/dev/null || echo "‚ö†Ô∏è  No logs available"
          VERIFY_SCRIPT

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          ssh-keygen -f ~/.ssh/known_hosts -R "${{ secrets.VPS_HOST }}" 2>/dev/null || true

  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Deployment Status
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          DEPLOY_STATUS="${{ needs.deploy.result }}"

          echo "Deploy Status: $DEPLOY_STATUS"

          if [ "$DEPLOY_STATUS" = "success" ]; then
            echo "‚úÖ Deployment completed successfully!"
            echo "üîó Application URL: http://$VPS_HOST"
            exit 0
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi
